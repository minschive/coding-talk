<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycom.codingtalk.mapper.InvitationMapper">

    <insert id="insertInvitation" parameterType="com.mycom.codingtalk.entity.Invitation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO invitations (chatroom_id, inviter_id, invitee_id, status)
        VALUES (#{chatroomId}, #{inviterId}, #{inviteeId}, #{status})
    </insert>

    <select id="selectInvitationById" resultMap="invitationDetailMap">
        SELECT i.*,
               c.name AS chatroom_name,
               u1.name AS inviter_name,
               u2.name AS invitee_name
        FROM invitations i
                 JOIN chatrooms c ON i.chatroom_id = c.id
                 JOIN users u1 ON i.inviter_id = u1.id
                 JOIN users u2 ON i.invitee_id = u2.id
        WHERE i.id = #{id}
    </select>

    <update id="updateInvitationStatus">
        UPDATE invitations
        SET status = #{status}, responded_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <select id="selectInvitationsByInviteeId" resultMap="invitationDetailMap">
        SELECT i.*,
               c.name AS chatroom_name,
               u1.name AS inviter_name,
               u2.name AS invitee_name
        FROM invitations i
                 JOIN chatrooms c ON i.chatroom_id = c.id
                 JOIN users u1 ON i.inviter_id = u1.id
                 JOIN users u2 ON i.invitee_id = u2.id
        WHERE i.invitee_id = #{inviteeId}
        ORDER BY i.invited_at DESC
    </select>

    <resultMap id="invitationDetailMap" type="com.mycom.codingtalk.entity.Invitation">
        <id property="id" column="id" />
        <result property="chatroomId" column="chatroom_id" />
        <result property="inviterId" column="inviter_id" />
        <result property="inviteeId" column="invitee_id" />
        <result property="status" column="status" />
        <result property="invitedAt" column="invited_at" />
        <result property="respondedAt" column="responded_at" />
        <result property="chatroomName" column="chatroom_name" />
        <result property="inviterName" column="inviter_name" />
        <result property="inviteeName" column="invitee_name" />
    </resultMap>
</mapper>
